<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VDO.Ninja Network Abstraction Demo</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
            }
            .container {
                border: 1px solid #ccc;
                padding: 20px;
                border-radius: 8px;
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }
            .connected {
                background: #d4edda;
                color: #155724;
            }
            .disconnected {
                background: #f8d7da;
                color: #721c24;
            }
            .messages {
                max-height: 300px;
                overflow-y: scroll;
                border: 1px solid #ddd;
                padding: 10px;
                margin: 10px 0;
                background: #f9f9f9;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
                cursor: pointer;
            }
            input {
                padding: 8px;
                margin: 5px;
            }
            .participants {
                margin: 10px 0;
                padding: 10px;
                background: #e9ecef;
                border-radius: 4px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>VDO.Ninja Network Demo</h1>
            <p>Using <code>VdoNinjaNetwork</code> class (Socket.IO style)</p>

            <div>
                <label>Room Name: <input
                        type="text"
                        id="roomName"
                        value="BadukClubTestRoomForDataOnly"
                    ></label>
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" disabled>Disconnect</button>
            </div>

            <div id="status" class="status disconnected">Not connected</div>

            <div class="participants">
                <strong>Your ID:</strong> <span id="yourId">-</span><br>
                <strong>Peers:</strong> <span id="peerCount">0</span>
            </div>

            <div>
                <h3>Send Message</h3>
                <input
                    type="text"
                    id="messageInput"
                    placeholder="Type a message"
                >
                <button id="sendBtn" disabled>Send 'chat'</button>
            </div>

            <div>
                <h3>Messages</h3>
                <div id="messages" class="messages"></div>
            </div>
        </div>

        <script type="module">
            import { VdoNinjaNetwork } from "./network.js";

            let network = null;
            // Map to store cursor elements: streamID -> HTMLDivElement
            const cursors = new Map();

            const connectBtn = document.getElementById(
                "connectBtn",
            );
            const disconnectBtn = document.getElementById(
                "disconnectBtn",
            );
            const sendBtn = document.getElementById("sendBtn");
            const statusDiv = document.getElementById("status");
            const messagesDiv = document.getElementById(
                "messages",
            );
            const yourIdSpan = document.getElementById(
                "yourId",
            );
            const peerCountSpan = document.getElementById(
                "peerCount",
            );

            function addMessage(msg) {
                const div = document.createElement("div");
                div.textContent = `[${
                    new Date().toLocaleTimeString()
                }] ${msg}`;
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop =
                    messagesDiv.scrollHeight;
            }

            function updatePeerCount() {
                if (network) {
                    peerCountSpan.textContent =
                        network.peers.size;
                }
            }

            // Throttling function to prevent flooding the network
            function throttle(func, limit) {
                let inThrottle;
                return function () {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(
                            () => inThrottle = false,
                            limit,
                        );
                    }
                };
            }

            // Mouse move handler - active all the time but checks for network
            window.addEventListener(
                "mousemove",
                throttle((event) => {
                    if (!network || !network.streamID) return;

                    network.send("MouseDetails", {
                        x: event.clientX,
                        y: event.clientY,
                    });
                }, 50), // Send every 50ms (20fps)
            );

            connectBtn.addEventListener("click", () => {
                const roomName = document.getElementById(
                    "roomName",
                ).value.trim();

                if (!roomName) {
                    alert("Please enter a room name");
                    return;
                }

                // Initialize the network
                network = new VdoNinjaNetwork(roomName);

                // Setup event listeners
                network.on("connected", () => {
                    statusDiv.textContent =
                        `Connected to room: ${roomName}`;
                    statusDiv.className = "status connected";
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                    addMessage("Connected to VDO.Ninja");
                });

                network.on("ready", (streamID) => {
                    yourIdSpan.textContent = streamID;
                    addMessage(`Ready! Your ID: ${streamID}`);
                });

                network.on("peer-joined", (streamID) => {
                    addMessage(`Peer joined: ${streamID}`);
                    updatePeerCount();
                });

                network.on("peer-left", (streamID) => {
                    addMessage(`Peer left: ${streamID}`);
                    updatePeerCount();

                    // Cleanup cursor
                    const cursor = cursors.get(streamID);
                    if (cursor) {
                        cursor.remove();
                        cursors.delete(streamID);
                    }
                });

                network.on("disconnected", () => {
                    statusDiv.textContent = "Not connected";
                    statusDiv.className = "status disconnected";
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    yourIdSpan.textContent = "-";
                    peerCountSpan.textContent = "0";
                    addMessage("Disconnected");

                    // Cleanup all cursors
                    cursors.forEach((cursor) =>
                        cursor.remove()
                    );
                    cursors.clear();
                });

                // Listen for specific 'chat' messages
                network.on("chat", (data) => {
                    addMessage(
                        `[CHAT] ${data.sender}: ${data.payload.message}`,
                    );
                });

                // Listen for mouse movements
                network.on("MouseDetails", (data) => {
                    // data.sender is the streamID
                    // data.payload should be { x: 0, y: 0 }

                    const { x, y } = data.payload;
                    const sender = data.sender;

                    // Don't draw our own cursor from network events
                    if (sender === network.streamID) return;

                    let cursorDiv = cursors.get(sender);

                    if (!cursorDiv) {
                        cursorDiv = document.createElement(
                            "div",
                        );
                        cursorDiv.style.position = "absolute";
                        cursorDiv.style.width = "10px";
                        cursorDiv.style.height = "10px";
                        cursorDiv.style.backgroundColor = "red";
                        cursorDiv.style.borderRadius = "50%";
                        cursorDiv.style.pointerEvents = "none"; // Pass through clicks
                        cursorDiv.style.zIndex = "9999";

                        // Add label
                        const label = document.createElement(
                            "div",
                        );
                        label.textContent = sender;
                        label.style.position = "absolute";
                        label.style.top = "-20px";
                        label.style.left = "0";
                        label.style.fontSize = "10px";
                        label.style.whiteSpace = "nowrap";
                        label.style.backgroundColor =
                            "rgba(255, 255, 255, 0.8)";
                        label.style.padding = "2px 4px";
                        label.style.borderRadius = "3px";
                        cursorDiv.appendChild(label);

                        document.body.appendChild(cursorDiv);
                        cursors.set(sender, cursorDiv);
                    }

                    // Update position
                    cursorDiv.style.left = x + "px";
                    cursorDiv.style.top = y + "px";
                });

                // Connect!
                network.connect();
                addMessage(
                    `Connecting to room: ${roomName}...`,
                );
            });

            disconnectBtn.addEventListener("click", () => {
                if (network) {
                    network.disconnect();
                    network = null;
                }
            });

            sendBtn.addEventListener("click", () => {
                const message =
                    document.getElementById("messageInput")
                        .value;
                if (message && network) {
                    // Send a typed message
                    network.send("chat", { message: message });

                    addMessage(`You sent: ${message}`);
                    document.getElementById("messageInput")
                        .value = "";
                }
            });
        </script>
    </body>
</html>
